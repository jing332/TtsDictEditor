name: Build Test

on:
    push:
        branches:
            - "master"
        paths-ignore:
            - "README.md"
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-java@v3
              with:
                  distribution: temurin
                  java-version: 17

            - name: Setup Gradle
              uses: gradle/gradle-build-action@v2

            - name: Init Signature
              run: |
                touch local.properties
                echo ALIAS_NAME='${{ secrets.ALIAS_NAME }}' >> local.properties
                echo ALIAS_PASSWORD='${{ secrets.ALIAS_PASSWORD }}' >> local.properties
                echo KEY_PASSWORD='${{ secrets.KEY_PASSWORD }}' >> local.properties
                echo KEY_PATH='./key.jks' >> local.properties
                # 从Secrets读取无换行符Base64解码, 然后保存到到app/key.jks
                echo ${{ secrets.KEY_STORE }} | base64 --decode > $GITHUB_WORKSPACE/app/key.jks

            - name: Grant execute permission for gradlew
              run: chmod +x gradlew
            - name: Build with Gradle
              run: ./gradlew assembleRelease -build-cache --parallel --daemon --warning-mode all

            - name: Upload App To Artifact
              if: success () || failure ()
              uses: actions/upload-artifact@v3
              with:
                  name: "TtsDictEditor"
                  path: ${{ github.workspace }}/app/build/outputs/apk/release/*.apk